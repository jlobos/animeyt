Tawea.log=function(a,b){this.models.session.debug&&console.log(a,b)};var Communicator={Iframe:function(){this.messagesReceived=[],this.messagesSent=[],this.messagesFlow=[]},DebugArray:function(a){this.data=[],this.count=0,this.type=a,this.push=function(a){this.data.push(a);var b={event:Events.consoleDebug,data:{type:this.type,count:this.count,message:a}};this.count++;var c="TaweaDebug_"+this.type+"_"+Tawea.worker.idIframe;localStorage[c]=JSON.stringify(b)},Tawea.models.session.debug&&window.addEventListener("storage",function(a){var b="TaweaDebug_"+this.type+"_"+Tawea.worker.idIframe;if(a.key==b&&"Init"==a.newValue){var c={event:Events.iframeData,data:{type:this.type,count:this.count,messages:this.data}};this.count++,localStorage[b]=JSON.stringify(c)}}.bind(this),!1)},setProto:function(a,b,c){a.prototype=b,a.prototype.constructor=a,a.prototype._super=c},setProtoIframe:function(a){this.setProto(a,new Communicator.iframe,Communicator.Iframe.prototype)},iframe:function(){}};Communicator.Iframe.prototype.send=function(a,b){Tawea.models.session.debug&&(a.flowType="Sent",b.messagesSent.push(a),b.messagesFlow.push(a))},Communicator.Iframe.prototype.onMsg=function(a,b){var c=JSON.parse(a);return"object"==typeof c&&Tawea.models.session.debug&&(c.flowType="Received",b.messagesReceived.push(c),b.messagesFlow.push(c)),c};var WebWorker=function(){Communicator.Iframe.call(this),this.worker=null,window.hasOwnProperty("SharedWorker")&&this.init()};Communicator.setProtoIframe(WebWorker),WebWorker.prototype.onMsg=function(a){var b=this._super.onMsg(a.data,this);if(null!=b){if("object"==typeof b)if(b.event==Events.workerRunning||b.event==Events.workerReady)this.sayHi(),Tawea.worker.idIframe=b.data.idIframe,Tawea.tab.changeVisibility(Tawea.models.session.visibility),b.data.statusCode+""!=Tawea.models.session.statusCode+""&&this.setSession();else if(b.event==Events.iframeData){var c=!1;b.data.hasOwnProperty("boxStatus")&&(c=b.data.boxStatus),Tawea.models.session.autoHide&&!c&&Tawea.brotherhood.setOver(!Tawea.models.session.autoHide)}else if(b.event==Events.session){Tawea.models.session.get("visibility")!=b.data.visibility&&Tawea.tab.changeVisibility(b.data.visibility,!0);var d="autoHide";200==b.data.statusCode?(Tawea.models.session.set("id",b.data.id),Tawea.models.session.set("name",b.data.name),Tawea.models.session.set("facebookAccessToken",b.data.facebookAccessToken),Tawea.models.session.set("taweaAccessToken",b.data.taweaAccessToken),Tawea.models.session.set("appId",b.data.appId),Tawea.models.session.set("autoHide",b.data.autoHide),localStorage[d]=b.data.autoHide):localStorage.hasOwnProperty(d)?Tawea.models.session.set(d,JSON.parse(localStorage[d])):Tawea.models.session.set(d,!0),Tawea.models.session.set("statusCode",b.data.statusCode),Tawea.models.session.set("visibility",b.data.visibility),401==b.data.statusCode&&"Toolbar"!=Tawea.models.session.iframeType&&Tawea.tab.closeIframe()}else b.event==Events.iframeVisibility?Tawea.tab.send(b):b.event==Events.workerException&&console.error("Error: %s\n%s\n%s",b.data.message,b.data.name,b.data.stack);this.onMessage(b)}},WebWorker.prototype.onMessage=function(a){self.addEventListener("load",function(){this.onMessage(a)}.bind(this),!1)},WebWorker.prototype.init=function(){this.worker=new SharedWorker(workerUrl,workerScope),this.worker.port.addEventListener("message",function(a){this.onMsg(a)}.bind(this),!1),this.worker.port.start(),self.onbeforeunload=this.closeIframe.bind(this)},WebWorker.prototype.send=function(a){this._super.send(a,this),this.worker.port.postMessage(JSON.stringify(a))},WebWorker.prototype.registerMouseAction=function(a){if(200==Tawea.models.session.statusCode){var b={event:Events.statsMouse,data:{iframeType:Tawea.models.session.iframeType,clickType:a.type,button:a.button,clientX:a.clientX,clientY:a.clientY,screenX:a.screenX,screenY:a.screenY,statusCode:Tawea.models.session.statusCode,route:window.location.hash}};this.send(b)}},WebWorker.prototype.sayHi=function(){var a={event:Events.iframeHi,data:{idTab:"",url:Tawea.models.session.url,type:Tawea.models.session.iframeType,session:{statusCode:Tawea.models.session.statusCode}}};Tawea.models.hasOwnProperty("friend")&&(a.data.friendId=Tawea.models.friend.id.replace(/ /g,"+")),this.send(a)},WebWorker.prototype.setSession=function(){var a={event:Events.session,data:Tawea.models.session};this.send(a)},WebWorker.prototype.setBadgeText=function(a){var b={event:Events.setBadgeText,data:{text:a}};this.send(b)},WebWorker.prototype.closeIframe=function(a){var a={event:Events.iframeBye};this.send(a)},WebWorker.prototype.changeVisibility=function(a){var b={event:Events.iframeVisibility,data:{visibility:a}};this.send(b)},WebWorker.prototype.initTawea=function(){if(200==Tawea.models.session.statusCode){navigator.userAgent.toLowerCase().indexOf("safari")>=0&&navigator.userAgent.toLowerCase().indexOf("chrome")<0;var a={event:Events.taweaInit,data:{session:Tawea.models.session,domain:window.location.host,notWebSocket:!0,debug:!("tawea.com"==window.location.host||"www.tawea.com"==window.location.host)}};this.send(a)}},WebWorker.prototype.openPopup=function(a,b,c,d,e){var f={event:Events.popupOpen,data:{url:a,name:b,specs:c,replace:d,extra:e}};this.send(f)};var Tab=function(a){Communicator.Iframe.call(this),this.windowProxy=null,Tawea.models.session.debug&&(this.messagesFlow=new Communicator.DebugArray("PostMessage")),this.init(a)};Communicator.setProtoIframe(Tab),Tab.prototype.onMsg=function(a){var b=this._super.onMsg(a.data,this);b.event!=Events.iframeOver||Tawea.models.iframe.ignore||Tawea.brotherhood.sendOver(b.data.over),b.event==Events.dragEvent?"dragend"==b.data.type&&Tawea.brotherhood.sendOver(!1):Tawea.models.session.debug&&b.event==Events.consoleOpen&&Tawea.worker.openPopup("http://"+window.location.host+"/extension/debugIframe.php?id="+Tawea.worker.idIframe+"&iframeType="+Tawea.models.session.iframeType+"&type="+b.data.type,"Debug "+Tawea.models.session.iframeType+" "+Tawea.worker.idIframe,"width=1280,height=1024,top=0,left=0"),this.onMessage(b)},Tab.prototype.onMessage=function(){},Tab.prototype.init=function(a){this.windowProxy=new Porthole.WindowProxy(a),this.windowProxy.addEventListener(function(a){this.onMsg(a)}.bind(this))},Tab.prototype.send=function(a){this._super.send(a,this),this.windowProxy.post(JSON.stringify(a))},Tab.prototype.changeVisibility=function(a){var b={event:Events.iframeVisibility,data:{visibility:a,omg:!0}};this.send(b)},Tab.prototype.setBoundsIframe=function(a){var b={event:Events.iframeBounds,data:{bounds:a}};this.send(b)},Tab.prototype.onFocus=function(){Tawea.models.session.set("focus",!0)},Tab.prototype.onBlur=function(){Tawea.models.session.set("focus",!1)},Tab.prototype.closeIframe=function(a){var a={event:Events.iframeClose};this.send(a)},Tab.prototype.doLogin=function(){var a=440,b=214,c=screen.width/2-a/2,d=screen.height/2-b/2;window.open("http://"+window.location.host+"/extension/prelogin.php","popup_id","width="+a+",height="+b+",top="+d+",left="+c)},Tab.prototype.reportError=function(){var a=400,b=200,c=screen.width/2-a/2,d=screen.height/2-b/2,e=window.open("http://"+window.location.host+"/extension/report.php","popup_id","width="+a+",height="+b+",top="+d+",left="+c);e.isPopup=!0},Tab.prototype.doLogout=function(){this.openIframe("Logout","logout")},Tab.prototype.doSettings=function(a){this.openIframe("Settings","settings&settings="+JSON.stringify(a))},Tab.prototype.openIframe=function(a,b){var c=document.createElement("iframe"),d=a+"_"+Math.floor(1e9*Math.random()+1);c.style.display="none",c.id=d,c.name=d,c.src="http://"+document.location.host+"?m="+b+"&idiframe="+d,document.body.appendChild(c)};var Brotherhood=function(){Communicator.Iframe.call(this),Tawea.models.session.debug&&(this.messagesFlow=new Communicator.DebugArray("Brotherhood")),this.key="TaweaTab",this.count=0,this.init(),this.overTimeout=null};Communicator.setProtoIframe(Brotherhood),Brotherhood.prototype.onMsg=function(a){var b=this._super.onMsg(a,this);b.event!=Events.iframeOver||Tawea.models.iframe.ignore||Tawea.models.dragBox.drag||(null!=this.overTimeout&&clearTimeout(this.overTimeout),this.setOver(b.data.over)),this.onMessage(b)},Brotherhood.prototype.onMessage=function(){},Brotherhood.prototype.init=function(){window.addEventListener("storage",function(a){a.key==this.key&&this.onMsg(a.newValue)}.bind(this),!1);var a="autoHide";200!=Tawea.models.session.get("statusCode")&&(localStorage.hasOwnProperty(a)?Tawea.models.session.set(a,JSON.parse(localStorage[a])):Tawea.models.session.set(a,!0)),Tawea.models.session.autoHide&&this.sendOver(!1)},Brotherhood.prototype.send=function(a){this._super.send(a,this),a.sessionId=Tawea.worker.idIframe+"_"+this.count,this.count++,sessionStorage[this.key]=JSON.stringify(a)},Brotherhood.prototype.sendOver=function(a,b){null!=this.overTimeout&&clearTimeout(this.overTimeout);var c=300;a&&(c=0),this.overTimeout=setTimeout(function(){if(!Tawea.models.iframe.ignore||b){var c={event:Events.iframeOver,data:{over:a}};this.instance.send(c),this.instance.setOver(a)}}.bind({instance:this,force:b}),c)},Brotherhood.prototype.setOver=function(a,b){Tawea.models.iframe.set("over",a),!Tawea.models.session.autoHide||Tawea.models.iframe.ignore||b||(a?Tawea.tab.setBoundsIframe(Tawea.models.iframe.bounds.max):Tawea.tab.setBoundsIframe(Tawea.models.iframe.bounds.min))},Tawea.Iframe={close:function(){window.parent.document.getElementById(Tawea.models.session.idIframe).parentNode.removeChild(window.parent.document.getElementById(Tawea.models.session.idIframe))}},Tawea.worker=new WebWorker,Tawea.tab=new Tab(Tawea.models.session.url),Tawea.brotherhood=new Brotherhood;;function css_browser_selector(n){var b=n.toLowerCase(),f=function(c){return b.indexOf(c)>-1},h="gecko",k="webkit",p="safari",j="chrome",d="opera",e="mobile",l=0,a=window.devicePixelRatio?(window.devicePixelRatio+"").replace(".","_"):"1";var i=[(!(/opera|webtv/i.test(b))&&/msie\s(\d+)/.test(b)&&(l=RegExp.$1*1))?("ie ie"+l+((l==6||l==7)?" ie67 ie678 ie6789":(l==8)?" ie678 ie6789":(l==9)?" ie6789 ie9m":(l>9)?" ie9m":"")):(/firefox\/(\d+)\.(\d+)/.test(b)&&(re=RegExp))?h+" ff ff"+re.$1+" ff"+re.$1+"_"+re.$2:f("gecko/")?h:f("opera")?d+(/version\/(\d+)/.test(b)?" "+d+RegExp.$1:(/opera(\s|\/)(\d+)/.test(b)?" "+d+RegExp.$2:"")):f("konqueror")?"konqueror":f("blackberry")?e+" blackberry":f("android")?e+" android":f(j)?k+" "+j:f("crios")?k+" "+j:f("iron")?k+" iron":f("applewebkit/")?k+" "+p+(/version\/(\d+)/.test(b)?" "+p+RegExp.$1:""):f("mozilla/")?h:"",f("j2me")?e+" j2me":f("iphone")?e+" iphone":f("ipod")?e+" ipod":f("ipad")?e+" ipad":f("mac")?"mac":f("darwin")?"mac":f("webtv")?"webtv":f("win")?"win"+(f("windows nt 6.0")?" vista":""):f("freebsd")?"freebsd":(f("x11")||f("linux"))?"linux":"",(a!="1")?" retina ratio"+a:"","js portrait"].join(" ");if(window.jQuery&&!window.jQuery.browser){window.jQuery.browser=l?{msie:1,version:l}:{}}return i}(function(g,b){var c=css_browser_selector(navigator.userAgent);var f=g.documentElement;f.className+=" "+c;var a=c.replace(/^\s*|\s*$/g,"").split(/ +/);b.CSSBS=1;for(var e=0;e<a.length;e++){b["CSSBS_"+a[e]]=1}if(b.jQuery){(function(d){d(b).load(function(){var i="portarit",k="landscape";var j="smart",u="smartwide",v="tablet",q="tabletwide";var w=d(f);var s=0,o=0;function r(){switch(b.orientation){case 90:case -90:w.removeClass(i).addClass(k);break;default:w.removeClass(k).addClass(i);break}}if(w.hasClass("mobile")&&b.orientation!=undefined){d(b).on("orientationchange",r);r()}function h(){try{var l=g.documentElement.clientWidth||g.body.clientWidth;if(l==o){return}o=l;clearTimeout(s)}catch(m){}s=setTimeout(n,100)}function n(){try{w.removeClass(j).removeClass(u).removeClass(v).removeClass(q).removeClass("pc");w.addClass((o<=360)?j:(o<=640)?u:(o<=768)?v:(o<=1024)?q:"pc")}catch(l){}}setTimeout(function(){d(b).on("resize",h);h()},500)})})(b.jQuery)}})(document,window);;var Emoticons={Mapping:{Angel:["O:)","O:-)"],Cool:["B)","B-)"],Cry:[":'(",":'-(",";-(",";(","T_T","TT__TT"],Devil:["3:)","3:-)"],DevilLaugh:["3:D","3:-D"],Fools:[">_<",">.<"],Geek:["8)","8-)"],Heart:["<3","&lt3"],Kissy:[":*",":-*"],Laugh:[":D",":-D"],Meow:["^^","^_^","^-^"],Oh:[":o",":-o",":O",":-O"],Sad:[":(",":-("],Smile:[":)",":-)"],Speechless:[":|",":-|"],Tease:["xp","Xp",":p",":P"],Wink:[";)",";-)"],XD:["xd","XD","xD","Xd"]},getName:function(a){for(var b in this.Mapping)if(this.Mapping[b].indexOf(a)>-1)return b;return a},getHtml:function(a){if(a.length>4&&"[["==a.substr(0,2)&&"]]"==a.substr(a.length-2)){var b=a.substr(2,a.length-4);return this.createHtmlFacebook(b).outerHTML}for(var c in this.Mapping)if(this.Mapping[c].indexOf(a)>-1)return this.createHtml(c).outerHTML;return a},createHtml:function(a){var b=this.createImg(a);return b.src="//cdn."+document.location.host+"/extension/img/emoticons/"+a+".png",b},createHtmlFacebook:function(a){var b=this.createImg(a);return b.src="http://graph.facebook.com/"+a+"/picture",b},createImg:function(a){var b=document.createElement("img");return b.alt=a,b.draggable=!1,b.className="emoticon",b},urlify:function(a){var b=/(([a-z]+:\/\/)?(([a-z0-9\-]+\.)+([a-z]{2}|aero|arpa|biz|com|coop|edu|gov|info|int|jobs|mil|museum|name|nato|net|org|pro|travel|local|internal))(:[0-9]{1,5})?(\/[a-z0-9_\-\.~]+)*(\/([a-z0-9_\-\.]*)(\?[a-z0-9+_\-\.%=&amp;]*)?)?(#[a-zA-Z0-9!$&'()*+.=-_~:@/?]*)?)(\s+|$)/gi;return a.replace(b,function(a){var b="";null==c&&(c=a),c.indexOf("://")<0&&(b="http://");var c=a;return a.indexOf("www.facebook.com/messages/?action=read&tid=")>-1&&(c=Tawea.models.lang.actions.attc),'<a href="'+b+a+'">'+c+"</a>"})},parseAttachment:function(a){var b="<1 attachment>",c=a.indexOf("<1 attachment>");return c>-1&&(a=a.substring(0,c)+a.substring(c+b.length)),a},parseMessage:function(a){var b="";a=a.replace(/\&/g,"&amp;").replace(/\</g,"&lt").replace(/\>/g,"&gt").replace(/\"/g,"&quot").replace(/\'/g,"&apos;"),a=this.parseAttachment(a);for(var c=a.replace(/\u00a0/g," ").split(" "),d=0;d<c.length;d++)b+=" "+this.getHtml(this.urlify(c[d]));return b.substr(1)}};;Tab.prototype.askData=function(a){var b={youtube:{data:function(a,b){var c=a.data[0].value,d="https://gdata.youtube.com/feeds/api/videos/"+c+"?v=2&alt=json";$.getJSON(d,function(a){this.data.data.push({type:"data",value:a}),this.func(this.data)}.bind({func:b,data:a}))}},vimeo:{data:function(a,b){var c=a.data[0].value,d="http://vimeo.com/api/v2/video/"+c+".json?callback=?";$.getJSON(d,function(a){Tawea.log(a),this.data.data.push({type:"data",value:a}),this.func(this.data)}.bind({func:b,data:a}))}},dailymotion:{data:function(a,b){var c=a.data[0].value,d="https://api.dailymotion.com/video/"+c+"?fields=title,thumbnail_large_url,thumbnail_medium_url,description,aspect_ratio,3d,duration";$.getJSON(d,function(a){Tawea.log(a),this.data.data.push({type:"data",value:a}),this.func(this.data)}.bind({func:b,data:a}))}}};if(console.log("antes de send taw"),b.hasOwnProperty(a.nodeName))for(var c in b)a.nodeName==c&&b[c].data(a,this.sendTaw.bind(this));else this.sendTaw(a)},Tab.prototype.sendTaw=function(a){a.to=Tawea.models.friend.get("id");var b="http://"+window.location.host+"/extension/api/taw/?token="+Tawea.models.session.taweaAccessToken;$.post(b,a,function(a){200==a.meta.code?(Tawea.models.dragBox.set("status","successful"),Tawea.worker.sendMessage(a.data.url)):403==a.meta.code&&Tawea.models.dragBox.set("status","error");var b=document.getElementById("dragBox");b.classList.add("transparent"),setTimeout(function(){this.classList.remove("transparent"),Tawea.models.dragBox.set("drag",!1),Tawea.models.dragBox.set("drop",!1)}.bind(b),1e3)},"json")};;Tawea.models.dragBox=Ember.Object.create({drag:!1,drop:!1,status:"error"}),Tawea.models.iframe.set("bounds",{max:{marginTop:"-28px"},min:{marginTop:"-3px"}}),Tawea.models.iframe.set("ignore",!0),WebWorker.prototype.onMessage=function(a){if(a.event==Events.iframeData)Tawea.models.friend.set("id",a.data.friend.id),Tawea.models.friend.set("name",a.data.friend.name),Tawea.models.friend.set("statusChat",a.data.friend.statusChat),Tawea.models.friend.set("devices",a.data.friend.devices),Tawea.models.friend.set("boxStatus",a.data.boxStatus),Tawea.models.friend.set("newMessages",a.data.newMessages),Tawea.models.friend.set("firstName",a.data.friend.first_name),Tawea.models.iframe.set("ignore",a.data.boxStatus),Tawea.models.session.set("statusChat",a.data.connection.status),Tawea.chatController.setScroll(!0,0),Tawea.chatController.loadConversation(a.data.conversation);else if(a.event==Events.chatBoxMessage)Tawea.chatController.setScroll(!0,0),Tawea.models.friend.set("newMessages",a.data.unreadMessages),Tawea.chatController.addMessage(a.data.message);else if(a.event==Events.chatBoxMessageError)Tawea.chatController.setMessageError(a.data.message);else if(a.event==Events.chatStatus)Tawea.models.session.id!==a.data.id&&Tawea.models.friend.set("statusChat",a.data.statusChat);else if(a.event==Events.chatUnreadMessages)Tawea.models.friend.set("newMessages",a.data.unreadMessages);else if(a.event==Events.chatState)Tawea.models.chatBox.set("state",a.data.state);else if(a.event==Events.chatBoxClose)Tawea.tab.send(a),Tawea.worker.closeIframe();else if(a.event==Events.chatBoxSlide){Tawea.models.friend.set("boxStatus",a.data.boxStatus),a.data.boxStatus?Tawea.tab.setBoundsIframe({marginTop:"-289px",width:"260px"}):Tawea.tab.setBoundsIframe({marginTop:"-28px",width:"160px"}),Tawea.models.session.autoHide&&Tawea.brotherhood.sendOver(!1,!0);var b=!1;a.data.boxStatus&&(b=!0),Tawea.models.iframe.set("ignore",b)}else a.event==Events.chatConversation?(Tawea.chatController.loadOldConversation(a.data.conversation),Tawea.chatController.getCountMessages()>0&&Tawea.chatController.setScroll(!1,document.getElementById("conversation").scrollHeight)):a.event==Events.connectionStatus?Tawea.models.session.set("statusChat",a.data.connection.status):a.event==Events.tawData?(Tawea.chatController.setMessageTaw(a.data),Tawea.models.dragBox.set("drag",!1)):a.event==Events.session},WebWorker.prototype.sendState=function(a){var b={event:Events.chatState,data:a};this.send(b)},WebWorker.prototype.sendMessage=function(a){var b={event:Events.chatBoxMessage,data:{message:{message:a,created_time:new Date}}};this.send(b)},WebWorker.prototype.close=function(){var a={event:Events.chatBoxClose};this.send(a)},WebWorker.prototype.slide=function(a){null==a&&(Tawea.models.session.debug&&alert("Error in slide. BoxStatus = undefined. Changing to false (minimized) "),a=!1);var b={event:Events.chatBoxSlide,data:{boxStatus:a}};this.send(b)},WebWorker.prototype.chatConversation=function(a){var b={event:Events.chatConversation,data:{limit:15,offset:a}};this.send(b)},WebWorker.prototype.focus=function(a){var b={event:Events.iframeFocus,data:{focus:a}};this.send(b)},Tab.prototype.onMessage=function(a){if(a.event==Events.tawDrop)if(Tawea.models.dragBox.set("drop",!0),Tawea.models.dragBox.set("status","loading"),Tawea.models.dragBox.set("over",!1),Tawea.worker.slide(1),"a"!=a.data.nodeName&&"#text"!=a.data.nodeName)this.askData(a.data);else{Tawea.worker.sendMessage(a.data.data[0].value),Tawea.models.dragBox.set("status","successful");var b=document.getElementById("dragBox");b.classList.add("transparent"),setTimeout(function(){this.classList.remove("transparent"),Tawea.models.dragBox.set("drag",!1),Tawea.models.dragBox.set("drop",!1)}.bind(b),1e3)}else a.event==Events.dragEvent&&("dragover"==a.data.type?Tawea.models.dragBox.set("over",!0):"dragleave"==a.data.type?Tawea.models.dragBox.set("over",!1):"dragstart"==a.data.type?(Tawea.models.dragBox.set("drag",!0),Tawea.models.dragBox.set("boxStatus",Tawea.models.friend.get("boxStatus")),Tawea.models.chatBox.set("stateEmoticons",!1),Tawea.worker.slide(1)):"dragend"==a.data.type&&(Tawea.models.dragBox.get("drop")||(Tawea.models.dragBox.set("drag",!1),Tawea.models.dragBox.get("boxStatus")!=Tawea.models.friend.get("boxStatus")&&Tawea.worker.slide(Tawea.models.dragBox.get("boxStatus"))),Tawea.models.dragBox.set("over",!1)))},Tab.prototype.openTaw=function(a){var b={event:Events.tawOpen,data:{id:a.id,url:a.url}};this.send(b)},Tawea.ApplicationController=Ember.Controller.extend({messagesBinding:"Tawea.models.conversation",chatBoxBinding:"Tawea.models.chatBox",dragBoxBinding:"Tawea.models.dragBox",showInvite:function(){var a="Invite_"+this.chatBox.friend.id;return localStorage.hasOwnProperty(a)&&Date.now()<parseInt(localStorage[a])?!1:!0}.property("chatBox.invite","chatBox.friend.id"),invite:function(){var a="http://"+window.location.host+"/?m=invite";this.notNow(),Tawea.worker.sendMessage(a)},notNow:function(){var a="Invite_"+this.chatBox.friend.id,b=4;localStorage[a]=new Date(Date.now()+864e5*b).getTime(),this.chatBox.set("invite",localStorage[a])},showHeader:function(){return 1==this.chatBox.friend.boxStatus?Tawea.models.session.get("focus")?(this.chatBox.friend.set("newMessages",0),!0):!1:this.chatBox.friend.get("newMessages")>0}.property("chatBox.friend.boxStatus","chatBox.friend.newMessages","Tawea.models.session.focus"),showAnimation:function(){return 1==this.chatBox.friend.get("boxStatus")&&!Tawea.models.session.get("focus")&&this.chatBox.friend.get("newMessages")>0}.property("chatBox.friend.boxStatus","chatBox.friend.newMessages","Tawea.models.session.focus"),showInactiveHeaderMax:function(){return 1==this.chatBox.friend.get("boxStatus")&&!Tawea.models.session.get("focus")}.property("chatBox.friend.boxStatus","Tawea.models.session.focus"),showInactiveHeaderMin:function(){return 0==this.chatBox.friend.get("boxStatus")&&this.chatBox.friend.get("newMessages")<=0}.property("chatBox.friend.boxStatus","chatBox.friend.newMessages"),showConnected:function(){return this.chatBox.friend.get("boxStatus")&&this.chatBox.friend.get("showConnectedIcon")}.property("chatBox.friend.boxStatus","chatBox.friend.showConnectedIcon"),slide:function(){Tawea.worker.slide(!this.chatBox.friend.boxStatus),this.chatBox.set("stateEmoticons",!1)},close:function(){Tawea.worker.close()}}),Tawea.ApplicationView=Ember.View.extend({templateName:"application",classNames:["chatBox","boxParentV"]}),Tawea.models.chatBox=Ember.Object.create({state:Tawea.Model.ChatState.active,invite:null,friend:Tawea.models.friend,stateEmoticons:!1}),Tawea.chatController=Ember.Object.create({last:null,old:null,scroll:{update:!0,position:0},setScroll:function(a,b){this.scroll.update=a,this.scroll.position=b},parseMessage:function(a){return Tawea.Model.MessageChat.create({id:a.id,from:Tawea.Model.User.create({id:a.from.id,name:a.from.name}),originalMessage:a.originalMessage,message:a.message.htmlSafe(),date:Tawea.Model.Date.create({date:a.created_time}),error:a.error,taw:a.taw,type:a.type})},addMessage:function(a){a.hasOwnProperty("message")||(a.message=""),a.originalMessage=a.message,a.message=Emoticons.parseMessage(a.message);var b=this.parseMessage(a);if(null!==this.last){var c=Date.parse(a.created_time)-Date.parse(this.last.date.date);this.last.from.id===a.from.id&&6e4>c?Tawea.models.conversation[Tawea.models.conversation.length-1].pushObject(b):Tawea.models.conversation.pushObject(Ember.A([b]))}else Tawea.models.conversation.pushObject(Ember.A([b]));this.last=b},setMessageError:function(a){for(var b=0;b<Tawea.models.conversation.length;b++)for(var c=0;c<Tawea.models.conversation[b].length;c++)Tawea.models.conversation[b][c].get("id")==a.id&&Tawea.models.conversation[b][c].set("error",!0)},setMessageTaw:function(a){for(var b=0;b<Tawea.models.conversation.length;b++)for(var c=0;c<Tawea.models.conversation[b].length;c++)Tawea.models.conversation[b][c].get("id")==a.id&&Tawea.models.conversation[b][c].set("taw",a.taw)},addOldMessage:function(a,b){a.hasOwnProperty("message")||(a.message=""),a.originalMessage=a.message,a.message=Emoticons.parseMessage(a.message);var c=this.parseMessage(a);if(null!==this.old){var d=Date.parse(a.created_time)-Date.parse(this.old.date.date);this.old.from.id===a.from.id&&6e4>d?b[b.length-1].pushObject(c):b.pushObject(Ember.A([c]))}else b.pushObject(Ember.A([c]));this.old=c},loadConversation:function(a){for(var b=0;b<a.length;b++)this.addMessage(a[b],!0)},loadOldConversation:function(a){for(var b=new Ember.A([]),c=0;c<a.length;c++)this.addOldMessage(a[c],b);for(var c=0;c<b.length;c++)Tawea.models.conversation.insertAt(c,b[c]);this.old=null},getCountMessages:function(){for(var a=0,b=0;b<Tawea.models.conversation.length;b++)for(var c=0;c<Tawea.models.conversation[b].length;c++)a++;return a},setFocus:function(a){Tawea.worker.focus(!0),a.$().focus()}}),Tawea.ChatController=Ember.ArrayController.extend({messagesBinding:"application.messages",chatBoxBinding:"application.chatBox",myState:Tawea.Model.ChatState.active,getConversation:function(){Tawea.worker.chatConversation(Tawea.chatController.getCountMessages())},isWriting:function(){return this.chatBox.get("state")==Tawea.Model.ChatState.composing}.property("chatBox.state"),sendState:function(a){a!==this.get("myState")&&(Tawea.worker.sendState({state:a}),this.set("myState",a))},timerId:0,keyDown:function(){this.sendState(Tawea.Model.ChatState.composing),clearTimeout(this.timerId),this.timerId=setTimeout(function(){this.sendState(Tawea.Model.ChatState.active)}.bind(this),5e3)},swapEmoticons:function(){"CONNECTED"==Tawea.Strophe.status[Tawea.models.session.statusChat]&&this.chatBox.set("stateEmoticons",!this.chatBox.get("stateEmoticons"))},sendMessage:function(a){Tawea.worker.sendMessage(a)}}),Tawea.ChatView=Ember.View.extend({templateName:"chat",classNames:["chat","boxParentV","boxFlex"],didInsertElement:function(){var a=document.getElementById("conversation");a.addEventListener("scroll",function(a){0==a.scrollTop&&this.getConversation()}.bind(this.controller,a))},click:function(){Tawea.chatController.setFocus(this._childViews[3])}}),Tawea.SettingsController=Ember.ObjectController.extend({}),Tawea.SettingsView=Ember.View.extend({templateName:"settings",classNames:["settings","boxParentV"]}),Tawea.MessagesChatView=Ember.View.extend({templateName:"messagesChat",classNames:["message"],didInsertElement:function(){setInterval(function(){this.msgs[0].date.set("time",this.msgs[0].date.get("time")+1)}.bind(this),6e4)}}),Tawea.MessagesChatController=Ember.ArrayController.extend({msgs:[]}),Tawea.MessageView=Ember.View.extend({templateName:"message",classNames:["contMessage","boxFlex"],didInsertElement:function(){updateScroll("conversation")},isResource:function(){return"200"==msg.taw.code?!0:!1}}),Tawea.MessageErrorView=Ember.View.extend({templateName:"messageError",classNames:["contMessage","error","boxFlex","boxParentH"],attributeBindings:["title"],title:Tawea.models.lang.actions.rtry,didInsertElement:function(){updateScroll("conversation")},click:function(){Tawea.worker.sendMessage(this.msg.originalMessage)}}),Tawea.WriteMessageView=Ember.View.extend({classNames:["elegantScroll"],contenteditable:"true",attributeBindings:["contenteditable","autofocus"],click:function(){Tawea.chatController.scroll.update=!0,updateScroll("conversation"),Tawea.chatController.setFocus(this),this.controller.chatBox.set("stateEmoticons",!1)},onStatus:function(){"CONNECTED"!=Tawea.Strophe.status[Tawea.models.session.statusChat]?(this.$().prop("contentEditable",!1),this.$().context.parentElement.parentElement.classList.add("disabled"),Tawea.models.session.statusChat>0&&Tawea.models.session.statusChat<8&&this.$().prop("title",Tawea.models.lang.connection[Tawea.Strophe.status[Tawea.models.session.statusChat]])):(this.$().prop("contentEditable",!0),this.$().context.parentElement.parentElement.classList.remove("disabled"),this.$().removeAttr("title"))}.observes("Tawea.models.session.statusChat"),didInsertElement:function(){Tawea.models.session.get("focus")&&Tawea.chatController.setFocus(this)},getFocus:function(){this.controller.chatBox.friend.boxStatus&&(updateScroll("conversation"),setTimeout(function(){this.didInsertElement()}.bind(this),300))}.observes("this.controller.chatBox.friend.boxStatus"),isMessageCorrect:function(a){var b=/^\s*$/;return b.test(a)?!1:!0},keyDown:function(a){if(13===a.keyCode){var b=a.target.innerText;null==b&&(b=a.target.textContent),this.isMessageCorrect(b)&&this.controller.sendMessage(b),this.controller.chatBox.set("stateEmoticons",!1),a.target.innerHTML="",a.stopPropagation(),a.preventDefault()}else 27===a.keyCode?this.controller.application.close():this.controller.keyDown()}}),Tawea.DragBoxView=Ember.View.extend({templateName:"dragBox",classNames:["dragBox"],elementId:"dragBox",classNameBindings:["over:dragBoxHover"],over:function(){return this._context.dragBox.over}.property("this._context.dragBox.over"),statusDrop:function(){var a="icon-remove",b=this._context.dragBox.status;return"loading"==b?a="icon-spin icon-spinner":"successful"==b&&(a="icon-ok"),a}.property("this._context.dragBox.status")}),Tawea.TawView=Ember.View.extend({templateName:"taw",classNames:["taw","boxParentCenter","boxParentV"],classNameBindings:["isVideo:video:image"],title:"",duration:"",data:null,init:function(){this._super(),this.setData()},getData:function(a){if("200"==this.msg.taw.code)for(var b=0;b<this.msg.taw.tawData.data.length;b++)if(this.msg.taw.tawData.data[b].type===a)return this.msg.taw.tawData.data[b].value;return null},setData:function(){this.set("data",this.getData("data")),"youtube"==this.msg.taw.tawData.nodeName?(this.set("title",this.data.entry.title.$t),this.set("duration",moment(moment.duration(parseInt(this.data.entry.media$group.yt$duration.seconds),"seconds")).format("mm:ss"))):"vimeo"==this.msg.taw.tawData.nodeName?(this.set("title",this.data[0].title),this.set("duration",moment(moment.duration(parseInt(this.data[0].duration),"seconds")).format("mm:ss"))):"dailymotion"==this.msg.taw.tawData.nodeName&&(this.set("title",this.data.title),this.set("duration",moment(moment.duration(parseInt(this.data.duration),"seconds")).format("mm:ss")))},isVideo:function(){return"video_html5"==this.msg.taw.tawData.nodeName||"youtube"==this.msg.taw.tawData.nodeName||"vimeo"==this.msg.taw.tawData.nodeName||"dailymotion"==this.msg.taw.tawData.nodeName}.property("this.msg.taw"),didInsertElement:function(){"img"==this.msg.taw.tawData.nodeName?this.$().context.firstElementChild.style.backgroundImage="url("+this.msg.taw.tawData.data[1].value+")":"video_html5"==this.msg.taw.tawData.nodeName?this.$().context.firstElementChild.style.backgroundColor="black":"youtube"==this.msg.taw.tawData.nodeName?this.$().context.firstElementChild.style.backgroundImage="url("+this.data.entry.media$group.media$thumbnail[1].url+")":"vimeo"==this.msg.taw.tawData.nodeName?this.$().context.firstElementChild.style.backgroundImage="url("+this.data[0].thumbnail_medium+")":"dailymotion"==this.msg.taw.tawData.nodeName&&(this.$().context.firstElementChild.style.backgroundImage="url("+this.data.thumbnail_medium_url+")"),updateScroll("conversation")},mouseDown:function(a){0==a.button?Tawea.tab.openTaw(this.msg.taw.tawData):1==a.button&&window.open(this.msg.taw.tawData.url)}}),Tawea.EmoticonsController=Ember.ArrayController.extend({stateEmoticonsBinding:"Tawea.models.chatBox.stateEmoticons"}),Tawea.emoticonsController=Tawea.EmoticonsController.create({content:[],init:function(){for(var a in Emoticons.Mapping)this.pushObject(Tawea.Model.Emoticon.create({name:a,map:Emoticons.Mapping[a]}))},sendEmoticon:function(a){$("#writeMessage").append(" "+a.getEmoticon()+" "),this.setCaretToEnd($("#writeMessage")[0])},setCaretToEnd:function(a){if(a.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();b.selectNodeContents(a),b.collapse(!1);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if("undefined"!=typeof document.body.createTextRange){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}}}),Tawea.EmoticonsView=Ember.View.extend({templateName:"emoticons",classNames:["emoticons"],classNameBindings:["this.controller.stateEmoticons::hidden"]}),Tawea.Router.reopen({location:"none"}),Tawea.Router.map(function(){this.route("chat"),this.route("settings")}),Tawea.IndexRoute=Ember.Route.extend({redirect:function(){this.transitionTo("chat")}}),Tawea.ApplicationRoute=Ember.Route.extend({events:{goSettings:function(){this.transitionTo("settings")},goChat:function(){this.transitionTo("chat")}}}),Tawea.ChatRoute=Ember.Route.extend({setupController:function(a){a.set("application",this.controllerFor("application"))}}),updateScroll=function(a){var b=document.getElementById(a);null!==b&&(b.scrollTop=Tawea.chatController.scroll.update?b.scrollHeight-b.offsetHeight:b.scrollHeight-Tawea.chatController.scroll.position)},Tawea.Strophe={status:{0:"ERROR",1:"CONNECTING",2:"CONFAIL",3:"AUTHENTICATING",4:"AUTHFAIL",5:"CONNECTED",6:"DISCONNECTED",7:"DISCONNECTING",8:"ATTACHED"}},window.addEventListener("load",function(){1==Tawea.models.session.focus&&window.focus()}),window.addEventListener("storage",function(a){a.key.indexOf("Invite_"+this.friend.id)>-1&&this.set("invite",a.newValue)}.bind(Tawea.models.chatBox),!1);